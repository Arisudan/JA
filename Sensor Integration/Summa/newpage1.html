<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Cycle Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Base Styles to match the dark theme */
        body { background: #061018; color: #dfe9f3; font-family: Arial, Helvetica, sans-serif; margin: 8px; font-size: 14px; overflow: hidden; }
        .card { background: #0c1620; padding: 8px; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.6); }
        
        /* Dashboard Stat Styling (Mimicking the image) */
        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 10px; }
        .big { font-size: 70px; font-weight: 900; text-align: center; line-height: 1; margin-top: -5px; }
        .small { font-size: 11px; color: #9fb0c9; text-align: center; margin-top: 4px; }
        .stat-label { font-size: 14px; color: #dfe9f3; font-weight: bold; margin-bottom: 2px; }

        /* Control Button Styling */
        button { border: 0; cursor: pointer; transition: all 0.2s; padding: 8px 16px; border-radius: 4px; font-weight: bold; }
        button:hover { filter: brightness(110%); }
        .start { background: #5cb85c; color: #fff; } /* Adjusted Start color for contrast */
        .stop { background: #d9534f; color: #fff; } /* Adjusted Stop color for contrast */
        .reset { background: #5bc0de; color: #fff; } /* Adjusted Reset color for visibility */
        .download { background: #2a6199; color: #fff; }

        /* Layout and Chart Area */
        #top-container { display: flex; gap: 4px; height: 120px; }
        #chartWrap { margin-top: 8px; height: calc(100vh - 150px); padding: 6px; border-radius: 8px; border: 2px solid #032b3f; position: relative; }
        
        /* Sensor Activity Animation */
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .sensor-pulse { animation: pulse 0.5s infinite; background: #40e37a !important; box-shadow: 0 0 10px #40e37a; }
        
        /* Download Dropdown */
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background-color: #1a2a3a; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 4px; border: 1px solid #374151; }
        .dropdown-content button { color: #dfe9f3; padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; background: none; }
        .dropdown-content button:hover { background-color: #2d3748; }
        .show { display: block; }
    </style>
</head>
<body class="h-screen flex flex-col gap-1 p-2">

    <div id="top-container">
        <div class="card flex flex-grow-0 items-center justify-start gap-4">
            
            <div class="stat-box text-center">
                <div class="stat-label">ACTUAL</div>
                <div id="actual" class="big text-red-500">0.0</div>
                <div class="small">km/h</div>
            </div>

            <div class="stat-box text-center">
                <div class="stat-label">TARGET</div>
                <div id="target" class="big text-white">0.0</div>
                <div class="small">km/h</div>
            </div>

            <div class="stat-box text-center min-w-[100px]">
                <div class="stat-label">ELAPSED</div>
                <div id="time" class="text-4xl font-extrabold text-white">0.00</div>
                <div class="small">seconds</div>
            </div>
            
            <div class="stat-box text-center min-w-[80px]">
                <div class="stat-label">VIOLATIONS</div>
                <div id="viol" class="text-4xl font-extrabold text-red-500">0</div>
                <div class="small">count</div>
            </div>
        </div>

        <div class="card flex flex-grow-0 items-center justify-start gap-4 px-6">
            <button id="startBtn" class="start text-lg">Start</button>
            <button id="stopBtn" class="stop text-lg">Stop</button>
            <button id="resetBtn" class="reset text-lg">Reset</button>
        </div>
        
        <div class="card flex flex-grow justify-end items-center gap-6 px-6">
            
            <div class="flex flex-col text-right items-end">
                <div class="stat-label text-xs">SENSOR STATUS</div>
                <div class="flex items-center gap-1">
                    <div id="sensorLED" class="w-2 h-2 rounded-full bg-gray-600"></div>
                    <div class="text-xs font-bold text-gray-400">
                        <span id="sensorText">NPN Sensor IDLE</span>
                        <span id="pinText" class="text-[10px] block mt-[-2px]">Pin 17: HIGH</span>
                        <span id="speedText" class="text-[10px] block">Speed: 0.0 km/h</span>
                    </div>
                </div>
            </div>
            
            <label class="flex items-center gap-2">
                <div class="stat-label text-xs">WINDOW (s)</div>
                <input id="window" type="number" min="5" max="300" value="10" 
                    class="w-14 bg-gray-800 text-white text-center border border-gray-600 rounded p-1 text-sm">
            </label>

            <div class="relative">
                <button id="downloadBtn" class="download text-lg flex items-center gap-2">
                    <span style="font-size: 1.2em;">‚¨á</span> I Download
                </button>
                <div id="downloadDropdown" class="dropdown-content">
                    <button id="dlExcel">üìä Export to Excel (.xlsx)</button>
                    <button id="dlCsv">üìÑ Export to CSV (.csv)</button>
                    <button id="dlPng">üñºÔ∏è Export Chart Image (.png)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="chartWrap" class="card flex-1">
        <canvas id="chart"></canvas>
    </div>

    <div class="flex justify-between items-center px-1 mt-1 text-xs">
        <div class="flex items-center gap-2">
            <span id="wsStatusDot" class="w-2 h-2 rounded-full bg-red-500"></span>
            <span id="wsStatusText" class="text-gray-500">WS: closed</span>
        </div>
        <div id="flashMsg" class="text-red-400 font-bold text-sm opacity-0 transition-opacity duration-500"></div>
        <div class="text-gray-500">NPN SENSOR: MONITORING</div>
    </div>

<script>
    const WS_URL = "ws://localhost:8765"; // Port matches your backend.py
    let ws = null;
    let chart = null;
    let driveData = [], actualData = [], singlePoint = [], violationMarkers = [];
    let windowSeconds = 10; // Default matches the image
    let isRunning = false;
    
    // Data storage for download
    let recordedData = []; 
    let lastRecordedTime = -1;

    // --- UI Elements ---
    const els = {
        actual: document.getElementById('actual'),
        target: document.getElementById('target'),
        time: document.getElementById('time'),
        viol: document.getElementById('viol'),
        start: document.getElementById('startBtn'),
        stop: document.getElementById('stopBtn'),
        reset: document.getElementById('resetBtn'),
        wsDot: document.getElementById('wsStatusDot'),
        wsText: document.getElementById('wsStatusText'),
        sensorLed: document.getElementById('sensorLED'),
        sensorText: document.getElementById('sensorText'),
        pinText: document.getElementById('pinText'),
        speedText: document.getElementById('speedText'), // New element for speed display
        flash: document.getElementById('flashMsg'),
        dlBtn: document.getElementById('downloadBtn'),
        dlMenu: document.getElementById('downloadDropdown'),
        windowInput: document.getElementById('window')
    };

    // --- CHART SETUP ---
    function initChart(profileTimes, targetData, upperData, lowerData) {
        const ctx = document.getElementById('chart').getContext('2d');
        
        // Use profileTimes directly as labels
        const labels = profileTimes.map(t => t.toFixed(0)); 
        
        // Set chart data arrays based on profile length
        actualData = new Array(profileTimes.length).fill(null);
        singlePoint = new Array(profileTimes.length).fill(null);
        violationMarkers = []; 

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels, // Use profile times for X-axis labels
                datasets: [
                    // Order and colors match the image legend
                    { label: 'Upper', data: upperData, borderColor: '#ef4444', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.1 },
                    { label: 'Lower', data: lowerData, borderColor: '#3b82f6', borderWidth: 1, pointRadius: 0, fill: '-1', backgroundColor: 'rgba(59, 130, 246, 0.05)', tension: 0.1 },
                    { label: 'Target', data: targetData, borderColor: '#10b981', borderWidth: 2, pointRadius: 0, borderDash: [2, 2], tension: 0.1 },
                    { label: 'Actual', data: actualData, borderColor: '#fbbf24', borderWidth: 3, pointRadius: 0, fill: false, tension: 0.1 },
                    { label: 'Crosses', data: violationMarkers, type: 'scatter', pointStyle: 'crossRot', pointRadius: 8, pointBorderColor: '#ff0000', pointBorderWidth: 3, showLine: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: {
                    x: { 
                        type: 'linear', 
                        min: 0, max: windowSeconds, 
                        grid: { color: '#1f2937' }, 
                        ticks: { color: '#9ca3af' }, 
                        title: { display: true, text: 'Time (s)', color: '#6b7280' } 
                    },
                    y: { 
                        min: 0, max: 55, // Max speed based on image scale
                        grid: { color: '#1f2937' }, 
                        ticks: { color: '#9ca3af', font: {size: 14, weight: 'bold'} }, 
                        title: { display: true, text: 'Speed (km/h)', color: '#6b7280' } 
                    }
                },
                plugins: { 
                    legend: { 
                        labels: { 
                            color: '#d1d5db', 
                            boxWidth: 10,
                            generateLabels: (chart) => {
                                const labels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                // Override colors/symbols to match the image legend appearance
                                return labels.map(label => {
                                    if (label.text === 'Upper') label.fillStyle = '#ef4444';
                                    if (label.text === 'Lower') label.fillStyle = '#3b82f6';
                                    if (label.text === 'Target') label.fillStyle = '#10b981';
                                    if (label.text === 'Actual') label.fillStyle = '#fbbf24';
                                    if (label.text === 'Crosses') {
                                        label.fillStyle = '#ff0000';
                                        label.text = 'Cross';
                                        label.pointStyle = 'crossRot';
                                    }
                                    return label;
                                });
                            }
                        } 
                    },
                    annotation: { annotations: { timeLine: { type: 'line', scaleID: 'x', value: 0, borderColor: 'white', borderWidth: 1, borderDash: [4, 4] } } }
                }
            }
        });
    }

    // --- WEBSOCKET ---
    function connect() {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => {
            els.wsDot.classList.replace('bg-red-500', 'bg-green-500');
            els.wsText.innerText = "WS: open";
            // Ask for sensor status every 500ms
            setInterval(() => ws.send(JSON.stringify({ cmd: "sensor_status" })), 500);
        };
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === "profile") {
                // Initialize chart with received profile data
                driveData = msg.profile;
                initChart(driveData.time, driveData.target, driveData.upper, driveData.lower); 
                els.windowInput.value = windowSeconds; // Set default window to 10s
            } else if (msg.type === "update") {
                updateDashboard(msg);
            } else if (msg.type === "violation") {
                handleViolation(msg);
            } else if (msg.type === "sensor_status") {
                updateSensor(msg);
            } else if (msg.type === "reset") {
                resetUI();
            }
        };
        ws.onclose = () => {
            els.wsDot.classList.replace('bg-green-500', 'bg-red-500');
            els.wsText.innerText = "WS: closed";
            setTimeout(connect, 1000);
        };
    }

    function send(cmd, data={}) { if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ cmd, ...data })); }

    // --- CORE LOGIC ---
    function updateDashboard(data) {
        isRunning = data.running;
        // Keep stats display clean and match the image style
        els.actual.innerText = data.actual.toFixed(1);
        els.target.innerText = data.target.toFixed(1);
        els.time.innerText = data.time.toFixed(2);
        els.viol.innerText = data.violations;

        // Data Recording
        if (isRunning) {
            if (data.time !== lastRecordedTime) {
                recordedData.push({ 
                    time: data.time.toFixed(2), 
                    target: data.target.toFixed(2),
                    upper: data.upper.toFixed(2),
                    lower: data.lower.toFixed(2),
                    actual: data.actual.toFixed(2),
                    violations: data.violations,
                    cmvr_timer: data.cmvr_timer
                });
                lastRecordedTime = data.time;
            }
        }

        // Update Graph
        if (chart) {
            const timeIndex = driveData.time.findIndex(t => t >= data.time);
            const idx = timeIndex !== -1 ? timeIndex : driveData.time.length - 1;

            if (idx >= 0 && idx < actualData.length) {
                // Find the closest index in the profile data for visualization
                actualData[idx] = data.actual;
                // singlePoint.fill(null); singlePoint[idx] = data.actual; // Rider marker disabled for clean graph like the image
                
                // Scroll window
                let minX = Math.max(0, data.time - windowSeconds);
                chart.options.scales.x.min = minX;
                chart.options.scales.x.max = minX + windowSeconds;
                chart.options.plugins.annotation.annotations.timeLine.value = data.time;
                
                chart.update('none');
            }
        }
    }

    function handleViolation(data) {
        if(chart) {
            violationMarkers.push({x: data.time, y: data.actual});
            chart.update('none');
        }
        els.flash.innerText = `VIOLATION: ${data.side.toUpperCase()} LIMIT`;
        els.flash.style.opacity = 1;
        setTimeout(() => els.flash.style.opacity = 0, 1500);
    }

    function updateSensor(data) {
        if (data && data.current_speed !== undefined) {
            // Update sensor activity LED/Text
            if (data.sensor_active) {
                els.sensorLed.classList.add('sensor-pulse');
                els.sensorLed.classList.remove('bg-gray-600');
                els.sensorText.innerText = "NPN Sensor ACTIVE";
                els.sensorText.style.color = '#40e37a';
            } else {
                els.sensorLed.classList.remove('sensor-pulse');
                els.sensorLed.classList.add('bg-gray-600');
                els.sensorText.innerText = "NPN Sensor IDLE";
                els.sensorText.style.color = '#9fb0c9';
            }
            
            // Update PIN and Speed info
            els.pinText.innerText = `Pin ${data.gpio_pin}: ${data.gpio_level}`;
            els.speedText.innerText = `Speed: ${data.current_speed.toFixed(1)} km/h`;
        }
    }

    function resetUI() {
        recordedData = [];
        lastRecordedTime = -1;
        if (chart) {
            actualData.fill(null);
            violationMarkers = [];
            chart.options.scales.x.min = 0;
            chart.options.scales.x.max = windowSeconds;
            chart.update();
        }
        els.actual.innerText = "0.0";
        els.target.innerText = "0.0";
        els.time.innerText = "0.00";
        els.viol.innerText = "0";
    }

    // --- DOWNLOAD HANDLERS (As corrected previously) ---
    function downloadExcel() {
        if (recordedData.length === 0) { alert("No data recorded yet."); return; }
        
        const dataForExport = recordedData.map(d => ({
            'Time (s)': parseFloat(d.time),
            'Target Speed (km/h)': parseFloat(d.target),
            'Upper Limit (km/h)': parseFloat(d.upper),
            'Lower Limit (km/h)': parseFloat(d.lower),
            'Actual Speed (km/h)': parseFloat(d.actual),
            'Violations (Total)': d.violations,
            'CMVR Timer (s)': parseFloat(d.cmvr_timer)
        }));

        const ws = XLSX.utils.json_to_sheet(dataForExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Run Data");
        XLSX.writeFile(wb, `DriveCycle_Run_${Date.now()}.xlsx`);
    }

    function downloadCSV() {
        if (recordedData.length === 0) { alert("No data recorded yet."); return; }
        
        const headers = ['Time (s)', 'Target Speed (km/h)', 'Upper Limit (km/h)', 'Lower Limit (km/h)', 'Actual Speed (km/h)', 'Violations (Total)', 'CMVR Timer (s)'];
        
        const csvRows = recordedData.map(r => 
            `${r.time},${r.target},${r.upper},${r.lower},${r.actual},${r.violations},${r.cmvr_timer}`
        ).join("\n");
        
        const csv = headers.join(",") + "\n" + csvRows;
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `DriveCycle_Run_${Date.now()}.csv`;
        a.click();
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = `DriveCycle_Chart_${Date.now()}.png`;
        link.href = document.getElementById('chart').toDataURL('image/png', 1.0);
        link.click();
    }

    // --- EVENT LISTENERS ---
    els.start.onclick = () => send("start");
    els.stop.onclick = () => send("stop");
    els.reset.onclick = () => send("reset");
    
    els.windowInput.onchange = (e) => {
        windowSeconds = Number(e.target.value);
        if(chart) { 
            chart.options.scales.x.max = chart.options.scales.x.min + windowSeconds; 
            chart.update('none'); 
        }
    };

    // Dropdown Logic
    els.dlBtn.onclick = (e) => { e.stopPropagation(); els.dlMenu.classList.toggle('show'); };
    window.onclick = () => els.dlMenu.classList.remove('show');
    
    document.getElementById('dlExcel').onclick = downloadExcel;
    document.getElementById('dlCsv').onclick = downloadCSV;
    document.getElementById('dlPng').onclick = downloadImage;

    // Initialize connection
    connect();
</script>
</body>
</html>
