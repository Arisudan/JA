<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Drive Cycle Display</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        /* BASE & THEME */
        body {
            background: #061018;
            color: #dfe9f3;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 8px;
            font-size: 14px;
        }

        /* UTILITIES */
        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .card {
            background: #0c1620;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .text-center { text-align: center; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-center { justify-content: center; align-items: center; }

        /* STATS DISPLAY */
        .stat-label {
            font-size: 11px;
            color: #9fb0c9;
            margin-bottom: 2px;
            text-transform: uppercase;
            font-weight: 500;
        }
        .big {
            font-size: 128px;
            font-weight: 900;
            line-height: 1;
            margin-top: -12px; /* Adjust line height for display */
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #actual { color: #ff2222; } /* Actual speed dark bright red */
        #target { color: #ff2222; } /* Target speed dark bright red */
        #viol { color: #ff4d4d; background: #2a1010; } /* Violation red badge */
        #time { color: #f0f0f0; } /* Elapsed time white */

        /* CONTROLS */
        button {
            padding: 10px 18px;
            border-radius: 6px;
            border: 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: background 0.2s, transform 0.1s;
        }
        button:active {
            transform: scale(0.98);
        }
        .start { background: #5cb85c; color: #fff; }
        .start:hover { background: #4cae4c; }
        .stop { background: #d9534f; color: #fff; }
        .stop:hover { background: #c9302c; }
        .reset { background: #5bc0de; color: #fff; }
        .reset:hover { background: #46b8da; }
        .download-btn { background: #2a6199 !important; color: #fff !important; }
        .download-btn:hover { background: #1a4e7e !important; }

        /* SENSOR & INPUTS */
        .sensor-display {
            font-size: 12px;
            font-weight: bold;
            line-height: 1.5;
            padding: 6px 10px;
            border-radius: 6px;
            min-width: 160px;
            text-align: center;
        }
        #gpioPin, #window {
            font-size: 16px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background: #1a2a1a;
            border: 1px solid #333;
            color: #f0f0f0;
            text-align: center;
        }
        #window { width: 60px; }

        /* CHART & LEGEND */
        #chartWrap {
            margin-top: 10px;
            height: calc(100vh - 160px); /* Fill remaining space */
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #032b3f;
        }
        #legend {
            display: flex;
            gap: 25px;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        /* DOWNLOAD MENU */
        #downloadMenu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: #0c1620;
            border: 1px solid #333;
            border-radius: 4px;
            min-width: 150px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
            margin-top: 4px;
        }
        #downloadMenu button {
            width: 100%;
            padding: 10px 12px;
            background: none;
            border: none;
            color: #dfe9f3;
            text-align: left;
            cursor: pointer;
            border-radius: 0;
            font-weight: normal;
        }
        #downloadMenu button:hover { background: #1a2a3a; }
        #downloadMenu button:first-child { border-top-left-radius: 4px; border-top-right-radius: 4px; }
        #downloadMenu button:last-child { border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }


        /* STATUS & INDICATORS */
        #flash {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
        }
        .danger { background: #441111; color: #ffd8d8; }
        #wsstatus { color: #9fb0c9; font-weight: 500; font-size: 12px; }
        #wsval { color: #40e37a; font-weight: bold; }
        
        #sensorLED {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            margin-left: 5px;
            transition: all 0.3s;
        }
        .sensor-active-pulse {
            animation: pulse 0.6s infinite alternate;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 5px #ff6b6b; }
            100% { transform: scale(1.1); box-shadow: 0 0 15px #ff6b6b; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="row">
        <div class="card" style="display:flex;gap:20px;align-items:center">
            <div class="flex-col flex-center">
                <div class="stat-label">ACTUAL</div>
                <div id="actual" class="big">0.0</div>
                <div class="stat-label">km/h</div>
            </div>
            <div class="flex-col flex-center">
                <div class="stat-label">TARGET</div>
                <div id="target" class="big">0.0</div>
                <div class="stat-label">km/h</div>
            </div>
            <div class="flex-col flex-center" style="min-width:100px">
                <div class="stat-label">ELAPSED</div>
                <div id="time" class="stat-value" style="font-size:28px;background:#1a2a1a;">0.00</div>
                <div class="stat-label">seconds</div>
            </div>
            <div class="flex-col flex-center" style="min-width:100px">
                <div class="stat-label">VIOLATIONS</div>
                <div id="viol" class="stat-value">0</div>
                <div class="stat-label">count</div>
            </div>
        </div>

        <div class="card" style="flex:1;min-width:650px;display:flex;justify-content:space-between;align-items:center" id="controls">
            <div style="display:flex;gap:25px;align-items:center;flex:1;justify-content:flex-start">
                <button id="startBtn" class="start">Start Test</button>
                <button id="stopBtn" class="stop">Stop Test</button>
                <button id="resetBtn" class="reset">Reset</button>
            </div>

            <div style="display:flex;gap:20px;align-items:center">
                
                <div class="flex-col flex-center">
                    <div class="stat-label">SENSOR STATUS</div>
                    <div id="sensorStatus" class="sensor-display" style="background:#1a2a1a;color:#9fb0c9;min-width:180px">
                        NPN Sensor IDLE<br>
                        Pin 17: HIGH | Speed: 0.0 km/h
                    </div>
                </div>

                <div class="flex-col flex-center">
                    <div class="stat-label">GPIO PIN</div>
                    <div id="gpioPin" style="color:#40e37a;">Pin 17</div>
                </div>

                <label class="flex-col flex-center">
                    <div class="stat-label">WINDOW (s)</div>
                    <input id="window" type="number" min="5" max="300" value="10">
                </label>

                <div style="position:relative">
                    <button id="downloadBtn" class="download-btn" title="Download Test Data">
                        ‚¨á Download
                    </button>
                    <div id="downloadMenu">
                        <button id="downloadCsv">üìÑ CSV Data</button>
                        <button id="downloadXlsx">üìä Excel Data</button>
                        <button id="downloadPng">üñºÔ∏è Chart PNG</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chartWrap" class="card">
        <div id="legend"></div>
        <canvas id="chart"></canvas>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center">
        <div style="display:flex; align-items:center; gap:15px">
            <div id="wsstatus">WS: <span id="wsval" style="color:#ff6b6b">closed</span></div>
            <div id="flash" class="flash danger" style="display:none"></div>
        </div>
        
        <div style="display:flex; align-items:center">
            <span style="color:#9fb0c9;font-size:12px; margin-right:5px">NPN SENSOR:</span>
            <div id="sensorLED"></div>
            <span id="sensorModeText" style="color:#9fb0c9;font-size:12px;margin-left:5px">MONITORING</span>
        </div>
    </div>

<script>
const WS_URL = "ws://localhost:8765";
let ws = null;
let profile = {time:[], target:[], upper:[], lower:[]};
let chart = null;
let windowSeconds = 10;
let leadPct = 0.30;
let markerPoints = [];

// Data collection for download
let downloadData = [];
let isDataCollectionActive = false;
let lastLoggedTime = -1; // Use time value directly for higher fidelity
let lastLoggedViolationCount = 0; // Track violations for logging

function connect() {
    ws = new WebSocket(WS_URL);
    ws.onopen = ()=> { document.getElementById('wsval').innerText = "open"; document.getElementById('wsval').style.color = '#40e37a'; sendCmd({cmd:'sensor_status'}); };
    ws.onclose = ()=> { document.getElementById('wsval').innerText = "closed"; document.getElementById('wsval').style.color = '#ff6b6b'; setTimeout(connect,1000); };
    ws.onerror = ()=> document.getElementById('wsval').innerText = "error";
    ws.onmessage = (ev)=> {
        try {
            const obj = JSON.parse(ev.data);
            handleMsg(obj);
        } catch(e) { console.warn("bad ws msg", e); }
    };
}
function sendCmd(o){ if (ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(o)); }

function handleMsg(obj) {
    if (obj.type === 'profile') {
        profile = obj.profile;
        drawProfile();
    } else if (obj.type === 'update') {
        updateUI(obj);
        storeTestData(obj); // Store data for download
        addPoint(obj.time, obj.actual);

        if (obj.violations > lastLoggedViolationCount) {
            // New violation triggered (CMVR/AIS rule met)
            showFlash("CMVR VIOLATION #" + obj.violations + " - " + (obj.cross_side === 'upper' ? 'TOO FAST' : 'TOO SLOW'));
            addMarker(obj.time, obj.actual, obj.cross_side);
            lastLoggedViolationCount = obj.violations;
        }

    } else if (obj.type === 'reset') {
        resetLocalState();
    } else if (obj.type === 'sensor_status') {
        updateSensorStatus(obj);
    } else if (obj.type === 'sensor_realtime') {
        // Use the continuous sensor status for UI updates
        updateSensorStatus(obj); 
    } else if (obj.type === 'complete') {
        isDataCollectionActive = false;
        showFlash(`TEST COMPLETE! Violations: ${obj.violations}`);
    }
}

function updateUI(obj) {
    // UI STATS
    document.getElementById('actual').innerText = (obj.actual ?? 0).toFixed(1);
    document.getElementById('target').innerText = (obj.target ?? 0).toFixed(1);
    document.getElementById('time').innerText = (obj.time ?? 0).toFixed(2);
    
    // Violation counter flash
    const violCount = obj.violations ?? 0;
    const currentViol = parseInt(document.getElementById('viol').getAttribute('data-last') || '0');
    if (violCount > currentViol) {
        document.getElementById('viol').style.color = '#ff4d4d';
        document.getElementById('viol').style.fontWeight = 'bold';
        setTimeout(() => {
            document.getElementById('viol').style.color = '#ff4d4d';
            document.getElementById('viol').style.fontWeight = '700';
        }, 500);
    }
    document.getElementById('viol').innerText = violCount;
    document.getElementById('viol').setAttribute('data-last', violCount);
}

function updateSensorStatus(obj) {
    const sensorStatus = document.getElementById('sensorStatus');
    const gpioPin = document.getElementById('gpioPin');
    const sensorLED = document.getElementById('sensorLED');

    const isActive = obj.sensor_active;
    const detectionText = isActive ? "DETECTING" : "IDLE";
    const statusColor = isActive ? "#ff6b6b" : "#9fb0c9";
    const pinLevel = obj.gpio_level || (isActive ? 'LOW' : 'HIGH');
    const speed = (obj.current_speed || 0.0).toFixed(1);
    
    // Update sensor status text
    sensorStatus.innerHTML = `NPN Sensor ${detectionText}<br>Pin ${obj.gpio_pin || 17}: ${pinLevel} | Speed: ${speed} km/h`;
    sensorStatus.style.color = statusColor;
    
    // Update GPIO pin box color
    gpioPin.style.color = pinLevel === "LOW" ? "#ff6b6b" : "#40e37a";
    
    // Update sensor LED
    if (isActive) {
        sensorLED.style.background = "#ff6b6b";
        sensorLED.style.boxShadow = "0 0 10px #ff6b6b";
        sensorLED.classList.add('sensor-active-pulse');
    } else {
        sensorLED.style.background = "#666";
        sensorLED.style.boxShadow = "none";
        sensorLED.classList.remove('sensor-active-pulse');
    }
}

function drawProfile(){
    const times = profile.time || [];
    const tgt = (profile.target||[]).map((v,i)=>({x:times[i], y:v}));
    const up = (profile.upper||[]).map((v,i)=>({x:times[i], y:v}));
    const lo = (profile.lower||[]).map((v,i)=>({x:times[i], y:v}));
    const ctx = document.getElementById('chart').getContext('2d');
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type:'line',
        data: {
            datasets: [
                { label:'Upper', data: up, borderColor:'#ff4d4d', borderWidth:2, pointRadius:0, fill:false, tension:0.2 },
                { label:'Lower', data: lo, borderColor:'#4da6ff', borderWidth:2, pointRadius:0, fill:'-1', tension:0.2, backgroundColor:'rgba(77, 166, 255, 0.05)' },
                { label:'Target', data: tgt, borderColor:'#40e37a', borderWidth:2.5, pointRadius:0, fill:false, tension:0.2 },
                { label:'Actual', data: [], borderColor:'#ffd400', pointRadius:0, borderWidth:3, tension:0.2, showLine:true },
                { label:'Crosses', data: [], type:'scatter', pointStyle:'crossRot', pointRadius:10, pointBorderColor:'#ff4d4d', pointBorderWidth:3, showLine:false }
            ]
        },
        options: {
            animation: false,
            maintainAspectRatio: false,
            layout: { padding: { bottom: 25 } },
            scales: {
                x: { 
                    type:'linear', 
                    title:{display:true,text:'Time (s)', color:'#9fb0c9'}, 
                    ticks: { color: '#f0f0f0', font: { size: 14, weight: 'bold' } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: { 
                    min:0, 
                    max: Math.max(...up.map(p => p.y), 50) + 5, // Auto adjust max Y
                    title:{display:true,text:'Speed (km/h)', color:'#9fb0c9'}, 
                    ticks: { color: '#f0f0f0', font: { size: 14, weight: 'bold' } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: { 
                legend: { 
                    display:true, 
                    labels: {
                        color: '#dfe9f3',
                        usePointStyle: true
                    } 
                } 
            }
        }
    });

    // Custom legend to match the required format
    document.getElementById('legend').innerHTML = `
        <span style="color:#ff4d4d">‚ñ† Upper</span> &nbsp; 
        <span style="color:#4da6ff">‚ñ† Lower</span> &nbsp; 
        <span style="color:#40e37a">‚ñ† Target</span> &nbsp; 
        <span style="color:#ffd400">‚ñ† Actual</span> &nbsp; 
        <span style="color:#ff4d4d; font-weight:bold; font-size:18px">X Crosses</span>
    `;
}

function addPoint(t, actual){
    if (!chart || t===null || t===undefined || actual===null || actual===undefined) return;
    
    // Add data point
    chart.data.datasets[3].data.push({x:t, y:actual});
    
    // Only update chart every few points to reduce flicker
    const dataLength = chart.data.datasets[3].data.length;
    if (dataLength % 3 !== 0 && dataLength > 1) {
        return; // Skip some updates to reduce flicker
    }
    
    // Data pruning (less frequent)
    const keepMin = t - (windowSeconds + 1);
    chart.data.datasets.forEach(ds => {
        if (ds.data && Array.isArray(ds.data)) {
            ds.data = ds.data.filter(p => p.x >= keepMin || typeof p.x !== 'number');
        }
    });
    
    // Smooth scrolling
    let vmin = Math.max(0, t - (windowSeconds * leadPct));
    let vmax = vmin + windowSeconds;
    chart.options.scales.x.min = vmin;
    chart.options.scales.x.max = vmax;
    
    // Use minimal update mode
    chart.update('none');
}

function addMarker(t, actual, side) {
    if (!chart) return;
    const dataset = chart.data.datasets[4];
    // Push violation marker
    dataset.data.push({x:t, y: actual});
    chart.update('none');
}

function showFlash(text) {
    const el = document.getElementById('flash');
    el.innerText = text;
    el.style.display = 'inline-block';
    el.className = 'flash danger';
    setTimeout(()=>{ el.style.display='none'; }, 2000);
}

function resetLocalState() {
    if (chart) {
        // Clear data without full reload
        chart.data.datasets[3].data = [];
        chart.data.datasets[4].data = [];
        chart.options.scales.x.min = 0;
        chart.options.scales.x.max = windowSeconds;
        chart.update('none'); // Use 'none' mode to prevent reload
    }
    document.getElementById('actual').innerText = "0.0";
    document.getElementById('target').innerText = "0.0";
    document.getElementById('time').innerText = "0.00";
    document.getElementById('viol').innerText = "0";
    document.getElementById('viol').setAttribute('data-last', '0');
    lastLoggedViolationCount = 0;
    
    // Reset Download Data
    downloadData = [];
    lastLoggedTime = -1;
    isDataCollectionActive = false;
    
    // Reset sensor displays
    document.getElementById('sensorStatus').innerHTML = 'NPN Sensor IDLE<br>Pin 17: HIGH | Speed: 0.0 km/h';
    document.getElementById('sensorStatus').style.color = '#9fb0c9';
    document.getElementById('gpioPin').style.color = '#40e37a';
    document.getElementById('sensorLED').style.background = '#666';
    document.getElementById('sensorLED').style.boxShadow = 'none';
}

// Store data for download (high fidelity - checks last time stamp)
function storeTestData(obj) {
    if (!obj.running) return;
    
    if (obj.time !== lastLoggedTime) {
        downloadData.push({
            time: parseFloat(obj.time.toFixed(3)),
            target: parseFloat(obj.target.toFixed(3)),
            upper: parseFloat(obj.upper.toFixed(3)),
            lower: parseFloat(obj.lower.toFixed(3)),
            actual: parseFloat(obj.actual.toFixed(3)),
            violations: obj.violations,
            cmvr_timer: parseFloat(obj.cmvr_timer.toFixed(3))
        });
        lastLoggedTime = obj.time;
    }
}

// UI wiring - optimized to prevent chart disruption
document.getElementById('startBtn').onclick = ()=> { 
    isDataCollectionActive = true;
    sendCmd({cmd:'start'}); 
};
document.getElementById('stopBtn').onclick = ()=> { 
    isDataCollectionActive = false;
    sendCmd({cmd:'stop'}); 
};
document.getElementById('resetBtn').onclick = ()=> { 
    resetLocalState();
    sendCmd({cmd:'reset'}); 
};

// Auto-request sensor status every 2 seconds for real-time updates
setInterval(() => { sendCmd({cmd:'sensor_status'}); }, 2000);

document.getElementById('window').onchange = (e)=> {
    let v = parseFloat(e.target.value) || 10;
    windowSeconds = Math.max(5, Math.min(300, v));
    if (chart) {
        let t = chart.data.datasets[3].data.length > 0 ? chart.data.datasets[3].data[chart.data.datasets[3].data.length - 1].x : 0;
        let vmin = Math.max(0, t - (windowSeconds * leadPct));
        chart.options.scales.x.min = vmin;
        chart.options.scales.x.max = vmin + windowSeconds;
        chart.update('none');
    }
};

// Download menu toggle
document.getElementById('downloadBtn').onclick = (e) => {
    e.stopPropagation();
    const menu = document.getElementById('downloadMenu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
};

// Hide menu when clicking outside
document.addEventListener('click', () => {
    document.getElementById('downloadMenu').style.display = 'none';
});

// CSV Download
document.getElementById('downloadCsv').onclick = () => {
    if (downloadData.length === 0) { alert('No test data available.'); return; }
    
    const headers = ['time','target','upper','lower','actual','violations','cmvr_timer'];
    const csvContent = [
        headers.join(','),
        ...downloadData.map(row => `${row.time},${row.target},${row.upper},${row.lower},${row.actual},${row.violations},${row.cmvr_timer}`)
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `drive_cycle_test_${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    document.getElementById('downloadMenu').style.display = 'none';
};

// Excel Download
document.getElementById('downloadXlsx').onclick = () => {
    if (downloadData.length === 0) { alert('No test data available.'); return; }
    
    const worksheet = XLSX.utils.json_to_sheet(downloadData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Drive Cycle Test');
    
    const filename = `drive_cycle_test_${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.xlsx`;
    XLSX.writeFile(workbook, filename);
    document.getElementById('downloadMenu').style.display = 'none';
};

// PNG Image Download
document.getElementById('downloadPng').onclick = () => {
    if (!chart) { alert('No chart available. Start a test first to generate a chart.'); return; }
    try {
        const canvas = document.getElementById('chart');
        const exportCanvas = document.createElement('canvas');
        const exportCtx = exportCanvas.getContext('2d');
        
        exportCanvas.width = canvas.width;
        exportCanvas.height = canvas.height;
        
        exportCtx.fillStyle = '#1c2834'; // Dark background for export
        exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
        exportCtx.drawImage(canvas, 0, 0);
        
        exportCanvas.toBlob((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `drive_cycle_chart_${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.png`;
            a.click();
            window.URL.revokeObjectURL(url);
        }, 'image/png');
        
        document.getElementById('downloadMenu').style.display = 'none';
    } catch (error) {
        console.error('Error generating PNG:', error);
        alert('Error generating PNG image. Please try again.');
    }
};

connect();
</script>
</body>
</html>
