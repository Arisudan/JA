<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero Drive Cycle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Prevent scrolling on touch screens */
        body { background: #061018; color: #dfe9f3; font-family: Arial, sans-serif; overflow: hidden; touch-action: none; }
        
        /* Card styling */
        .card { background: #0c1620; border-radius: 8px; border: 1px solid #1f2937; }
        
        /* Animations */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .status-active { color: #4ade80; animation: pulse 1s infinite; }
        
        /* Compact Button */
        .btn-compact { padding: 8px 16px; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        .btn-compact:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col p-2 gap-2">

    <!-- TOP ROW: Header + Sensor Status (10% Height) -->
    <div class="flex justify-between items-center px-2">
        <div class="flex items-center gap-2">
            <div id="wsDot" class="w-3 h-3 rounded-full bg-red-500"></div>
            <h1 class="text-lg font-bold text-white tracking-wider">HERO DRIVE CYCLE</h1>
        </div>
        
        <!-- Sensor Status Box -->
        <div class="flex items-center gap-4 bg-gray-800 px-3 py-1 rounded border border-gray-700">
            <div class="text-right">
                <div class="text-[10px] text-gray-400">SENSOR</div>
                <div id="sensorText" class="text-xs font-bold text-gray-500">IDLE</div>
            </div>
            <div class="w-px h-6 bg-gray-600"></div>
            <div class="text-right">
                <div class="text-[10px] text-gray-400">PIN 17</div>
                <div id="pinText" class="text-xs font-mono text-gray-500">HIGH</div>
            </div>
        </div>
    </div>

    <!-- MIDDLE ROW: Big Stats (25% Height) -->
    <div class="grid grid-cols-4 gap-2 h-1/4">
        <!-- Actual Speed -->
        <div class="card flex flex-col justify-center items-center relative overflow-hidden">
            <div class="text-[10px] text-gray-400 absolute top-2 left-2">ACTUAL</div>
            <div id="actual" class="text-5xl font-black text-green-400">0.0</div>
            <div class="text-xs text-gray-500">km/h</div>
        </div>
        
        <!-- Target Speed -->
        <div class="card flex flex-col justify-center items-center relative">
            <div class="text-[10px] text-gray-400 absolute top-2 left-2">TARGET</div>
            <div id="target" class="text-5xl font-black text-white">0.0</div>
            <div class="text-xs text-gray-500">km/h</div>
        </div>
        
        <!-- Timer -->
        <div class="card flex flex-col justify-center items-center">
            <div class="text-[10px] text-gray-400">TIME</div>
            <div id="time" class="text-3xl font-bold text-blue-400">0.0</div>
            <div class="text-[10px] text-gray-500">sec</div>
        </div>
        
        <!-- Violations -->
        <div class="card flex flex-col justify-center items-center bg-red-900/10 border-red-900/30">
            <div class="text-[10px] text-red-400">VIOLATIONS</div>
            <div id="viol" class="text-4xl font-bold text-red-500">0</div>
        </div>
    </div>

    <!-- BOTTOM ROW: Chart (Flexible Height - Fills rest of screen) -->
    <div class="card flex-1 relative p-1 min-h-0">
        <canvas id="chart"></canvas>
    </div>

    <!-- FOOTER: Controls (10% Height) -->
    <div class="flex gap-2 h-[10%] min-h-[40px]">
        <button id="startBtn" class="btn-compact bg-green-600 text-white flex-1 text-lg">START</button>
        <button id="stopBtn" class="btn-compact bg-yellow-600 text-white flex-1 text-lg">STOP</button>
        <button id="resetBtn" class="btn-compact bg-gray-600 text-white w-24">RESET</button>
        <button id="dlBtn" class="btn-compact bg-blue-600 text-white w-32 flex items-center justify-center gap-2">
            <span>ðŸ“¥</span> EXCEL
        </button>
    </div>

<script>
    const WS_URL = "ws://localhost:8765";
    let ws, chart;
    let driveData = [], actualData = [], singlePoint = [], violationMarkers = [];
    let windowSeconds = 20; // How much time to show on graph

    // UI References
    const ui = {
        act: document.getElementById('actual'),
        tgt: document.getElementById('target'),
        tm: document.getElementById('time'),
        vio: document.getElementById('viol'),
        wsDot: document.getElementById('wsDot'),
        sen: document.getElementById('sensorText'),
        pin: document.getElementById('pinText'),
        start: document.getElementById('startBtn')
    };

    function initChart(targets) {
        const ctx = document.getElementById('chart').getContext('2d');
        const labels = targets.map((_, i) => i);
        const upper = targets.map(v => v + 2);
        const lower = targets.map(v => Math.max(0, v - 2));
        
        actualData = new Array(targets.length).fill(null);
        singlePoint = new Array(targets.length).fill(null);
        violationMarkers = [];

        if(chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Upper', data: upper, borderColor: '#ef4444', borderWidth: 1, fill: '+1', backgroundColor: 'rgba(239,68,68,0.1)', pointRadius: 0 },
                    { label: 'Lower', data: lower, borderColor: '#3b82f6', borderWidth: 1, fill: false, pointRadius: 0 },
                    { label: 'Target', data: targets, borderColor: '#10b981', borderWidth: 2, pointRadius: 0, borderDash: [0,0] },
                    { label: 'Actual', data: actualData, borderColor: '#fbbf24', borderWidth: 3, fill: false, pointRadius: 0, tension: 0.4 },
                    { label: 'Pos', data: singlePoint, pointStyle: 'triangle', pointRadius: 8, pointBackgroundColor: '#fbbf24', showLine: false },
                    { label: 'Viol', data: violationMarkers, type: 'scatter', pointStyle: 'crossRot', pointRadius: 6, pointBorderColor: 'red', showLine: false }
                ]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false, 
                animation: false,
                scales: {
                    x: { min: 0, max: windowSeconds, grid: {color: '#1f2937'}, ticks: {color: '#6b7280', font:{size:10}} },
                    y: { min: 0, max: 60, grid: {color: '#1f2937'}, ticks: {color: '#6b7280', font:{size:10, weight:'bold'}} }
                },
                plugins: { 
                    legend: { display: false },
                    annotation: { annotations: { line: { type: 'line', scaleID: 'x', value: 0, borderColor: 'white', borderWidth: 1, borderDash:[2,2] } } } 
                }
            }
        });
    }

    function connect() {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => {
            ui.wsDot.classList.replace('bg-red-500', 'bg-green-500');
            setInterval(() => ws.send(JSON.stringify({cmd: "sensor_status"})), 500);
        };
        ws.onmessage = (e) => {
            const m = JSON.parse(e.data);
            if (m.type === "profile") {
                driveData = m.profile.target;
                initChart(driveData);
            } else if (m.type === "update") {
                updateDisplay(m);
            } else if (m.type === "violation") {
                if(chart) { violationMarkers.push({x: m.time, y: m.actual}); chart.update('none'); }
            } else if (m.type === "csv_download") {
                downloadExcel(m.content, m.meta);
            } else if (m.type === "sensor_status") {
                ui.sen.innerText = m.sensor_active ? "ACTIVE" : "IDLE";
                ui.sen.className = m.sensor_active ? "text-xs font-bold text-green-400 status-active" : "text-xs font-bold text-gray-500";
                ui.pin.innerText = `PIN ${m.gpio_pin}: ${m.gpio_level}`;
            } else if (m.type === "reset") {
                resetDisplay();
            }
        };
        ws.onclose = () => {
            ui.wsDot.classList.replace('bg-green-500', 'bg-red-500');
            setTimeout(connect, 1000);
        };
    }

    function updateDisplay(d) {
        ui.act.innerText = d.actual.toFixed(1);
        ui.tgt.innerText = d.target.toFixed(1);
        ui.tm.innerText = d.time.toFixed(1);
        ui.vio.innerText = d.violations;

        if(d.time > 5 && (d.actual > d.upper || d.actual < d.lower)) ui.act.classList.replace('text-green-400', 'text-red-500');
        else ui.act.classList.replace('text-red-500', 'text-green-400');

        if(chart) {
            const idx = Math.floor(d.time);
            if(idx < driveData.length) {
                actualData[idx] = d.actual;
                singlePoint.fill(null); singlePoint[idx] = d.actual;
                
                // Smart Scrolling
                let minX = Math.max(0, d.time - (windowSeconds * 0.8));
                chart.options.scales.x.min = minX;
                chart.options.scales.x.max = minX + windowSeconds;
                chart.options.plugins.annotation.annotations.line.value = d.time;
                chart.update('none');
            }
        }
        
        if(d.running) {
            ui.start.innerText = "PAUSE";
            ui.start.className = "btn-compact bg-yellow-600 text-white flex-1 text-lg";
        } else {
            ui.start.innerText = "START";
            ui.start.className = "btn-compact bg-green-600 text-white flex-1 text-lg";
        }
    }

    function resetDisplay() {
        if(chart) {
            actualData.fill(null); singlePoint.fill(null); violationMarkers = [];
            chart.options.scales.x.min = 0; chart.options.scales.x.max = windowSeconds;
            chart.update();
        }
        ui.act.innerText = "0.0"; ui.tm.innerText = "0.0"; ui.vio.innerText = "0";
    }

    function downloadExcel(csv, meta) {
        if(!csv) return alert("No data");
        const rows = csv.trim().split('\n').map(r => r.split(','));
        const final = [["Hero Drive Cycle Report"], ["Start:", meta.start], ["End:", meta.end], [], ...rows];
        const ws = XLSX.utils.aoa_to_sheet(final);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Run Data");
        XLSX.writeFile(wb, `Run_${Date.now()}.xlsx`);
    }

    // --- EVENTS ---
    document.getElementById('startBtn').onclick = () => ws.send(JSON.stringify({cmd: "start"}));
    document.getElementById('stopBtn').onclick = () => ws.send(JSON.stringify({cmd: "stop"}));
    document.getElementById('resetBtn').onclick = () => ws.send(JSON.stringify({cmd: "reset"}));
    document.getElementById('dlBtn').onclick = () => ws.send(JSON.stringify({cmd: "download_log"}));

    connect();
</script>
</body>
</html>
