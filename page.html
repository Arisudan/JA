<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Drive Cycle - Rider Display</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <style>
    body { 
      background: #06060a; 
      color: #eaeaea; 
      font-family: "Segoe UI", "Consolas", Arial, sans-serif; 
      margin: 0; 
      padding: 8px;
      overflow-x: hidden;
    }
    
    /* 7-inch landscape display optimization */
    @media screen and (max-width: 1024px) and (max-height: 768px) {
      body { padding: 6px; }
      .compact-layout { font-size: 0.9em; }
    }
    
    #top { display: flex; gap: 10px; align-items: center; flex-wrap: nowrap; }
    
    /* Enhanced metric cards with green theme like dho.py */
    .card { 
      background: #0b0b0d; 
      padding: 12px; 
      border-radius: 10px; 
      border: 1px solid #303030;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
    }
    
    .metric-box {
      background-color: #12341f;
      border-radius: 6px;
      padding: 6px 8px;
      border: 1px solid #2f6b3f;
      margin: 2px 0;
      text-align: center;
      min-width: 85px;
      flex: 1;
    }
    
    .metric-label {
      font-size: 9px;
      color: #9fb0c9;
      font-family: "Consolas", monospace;
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 1px;
      line-height: 1.1;
    }
    
    .metric-value {
      font-family: "Consolas", monospace;
      font-weight: bold;
      color: #dfffe0;
      line-height: 1.1;
    }
    
    #speed { 
      font-size: 32px; 
      color: #2ecc71; 
      font-weight: 800; 
      font-family: "Consolas", monospace;
    }
    
    #target, #time, #viol { 
      font-size: 18px; 
      font-family: "Consolas", monospace;
      font-weight: bold;
    }
    
    #controls { 
      margin-left: 10px; 
      display: flex; 
      gap: 6px; 
      align-items: center;
      background: #0b0b0d;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #303030;
      flex-wrap: wrap;
    }
    
    #canvas-wrap { 
      margin-top: 8px; 
      background: #050507; 
      padding: 6px; 
      border-radius: 8px; 
      height: 320px; 
      border: 2px solid #ff4d4d;
    }
    
    #chart { width: 100%; height: 100%; display: block; }
    
    /* Enhanced buttons matching dho.py style */
    .btn { 
      padding: 8px 12px;
      background-color: #222;
      border: 2px solid #444;
      border-radius: 6px;
      font-weight: bold;
      font-size: 11px;
      font-family: "Consolas", monospace;
      color: white;
      cursor: pointer;
      min-width: 70px;
      transition: all 0.2s ease;
    }
    
    .btn:hover { background-color: #333; }
    .btn.start { background-color: #16a085; border-color: #16a085; }
    .btn.stop { background-color: #c0392b; border-color: #c0392b; }
    
    #slider { 
      width: 200px;
      height: 6px;
      background: #333;
      border-radius: 3px;
    }
    
    .small { 
      font-size: 11px; 
      color: #9fb0c9;
      font-family: "Consolas", monospace;
    }
    
    .label { 
      font-size: 11px; 
      color: #e6e6e6;
      font-family: "Consolas", monospace;
      font-weight: bold;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    
    #right-controls { 
      margin-left: auto; 
      display: flex; 
      gap: 8px; 
      align-items: center;
      flex-wrap: wrap;
    }
    
    #status { 
      font-family: "Consolas", monospace;
      font-weight: bold;
      color: #9fb0c9; 
      font-size: 12px;
    }
    
    #file-upload { 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      gap: 6px;
    }
    
    #csvFile { display: none; }
    
    .file-btn { 
      padding: 8px 12px;
      background: #2980b9;
      color: white;
      border: 2px solid #3498db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-family: "Consolas", monospace;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    
    .file-btn:hover { background: #3498db; }
    
    #fileName { 
      font-size: 10px;
      color: #dfffe0;
      font-family: "Consolas", monospace;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      background: #12341f;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #2f6b3f;
    }
    
    /* Input styling optimized for touch */
    input[type=\"number\"], select {
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      color: #eaeaea;
      padding: 8px;
      font-family: \"Consolas\", monospace;
      font-size: 11px;
      min-height: 30px;
      touch-action: manipulation;
    }
    
    select {
      font-size: 11px;
    }
    
    /* Range slider optimization for touch */
    input[type=\"range\"] {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: #333;
      border-radius: 4px;
      outline: none;
    }
    
    input[type=\"range\"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #2ecc71;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #fff;
    }
    
    input[type=\"range\"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #2ecc71;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #fff;
    }
    
    /* Touch-friendly button sizing */
    .btn, .file-btn {
      min-height: 36px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Prevent zoom on input focus */
    input, select, button {
      font-size: 16px;
    }
    
    @media screen and (max-width: 1024px) {
      input, select, button {
        font-size: 11px;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>

<body>
  <div style="text-align:center; margin-bottom:8px;">
    <h1 style="color:#f8f8f8; font-family:'Segoe UI',sans-serif; font-size:18px; font-weight:bold; margin:0;">Drive Cycle Dashboard</h1>
    <div style="color:#9fb0c9; font-family:'Consolas',monospace; font-size:10px; margin-top:2px;">Speed Monitoring & Analysis</div>
  </div>
  <div id="top">
    <div class="card" style="display:flex;gap:8px;align-items:center;flex:1;"
      <div class="metric-box">
        <div class="metric-label">Actual Speed</div>
        <div class="metric-value" id="speed">0.0</div>
        <div class="small">km/h</div>
      </div>
      <div class="metric-box">
        <div class="metric-label">Target Speed</div>
        <div class="metric-value" id="target">0.0</div>
        <div class="small">km/h</div>
      </div>
      <div class="metric-box">
        <div class="metric-label">Elapsed Time</div>
        <div class="metric-value" id="time">0.0</div>
        <div class="small">seconds</div>
      </div>
      <div class="metric-box">
        <div class="metric-label">Violations</div>
        <div class="metric-value" id="viol">0</div>
        <div class="small">count</div>
      </div>
    </div>

    <div id="controls" class="card">
      <button id="startBtn" class="btn start">START</button>
      <button id="stopBtn" class="btn stop">PAUSE</button>
      <button id="resetBtn" class="btn">RESET</button>

      <div style="margin-left:8px;">
        <div class="label">MODE</div>
        <select id="mode">
          <option value="manual">Manual (Slider)</option>
          <option value="real">Real Sensor</option>
        </select>
      </div>

      <div style="margin-left:6px;">
        <div class="label">SPEED</div>
        <input id="slider" type="range" min="0" max="140" step="0.1" value="0">
        <div id="sliderVal" class="small">0.0</div>
      </div>

      <div id="right-controls">
        <div id="file-upload">
          <div class="label">PROFILE CSV</div>
          <input type="file" id="csvFile" accept=".csv" />
          <button class="file-btn" onclick="document.getElementById('csvFile').click()">Browse</button>
          <div id="fileName">drive_cycles.csv</div>
        </div>
        <div>
          <div class="label">WINDOW (s)</div>
          <input id="windowIn" type="number" min="5" max="300" value="30" style="width:80px">
        </div>
        <div id="status" class="small">WS: disconnected</div>
      </div>
    </div>
  </div>

  <div id="canvas-wrap" class="card">
    <canvas id="chart"></canvas>
  </div>

<script>
const WS_URL = "ws://localhost:8765";
let ws = null;
let reconnectDelay = 1000;           // start delay
const MAX_RECONNECT_DELAY = 15000;   // exponential backoff cap
let reconnectTimer = null;
let hasProfile = false;

let profile = { time:[], target:[], upper:[], lower:[] };
let chart = null;
let windowSeconds = 30;

function setStatus(text) {
  const el = document.getElementById('status');
  if (el) el.innerText = "WS: " + text;
}

function connectWS() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;

  setStatus("connecting");
  try {
    ws = new WebSocket(WS_URL);
  } catch (err) {
    setStatus("failed");
    scheduleReconnect();
    return;
  }

  ws.onopen = () => {
    console.log("WS connected to", WS_URL);
    setStatus("connected");
    // reset backoff
    reconnectDelay = 1000;
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
  };

  ws.onmessage = (ev) => {
    try {
      const obj = JSON.parse(ev.data);
      handleMessage(obj);
    } catch (e) {
      console.warn("WS Parse Error:", e);
    }
  };

  ws.onclose = (ev) => {
    console.log("WS closed:", ev.code, ev.reason);
    setStatus("disconnected");
    scheduleReconnect();
  };

  ws.onerror = (e) => {
    console.log("WS error:", e);
    // socket will trigger onclose next; don't schedule here to avoid double reconnect
  };
}

function scheduleReconnect() {
  if (reconnectTimer) return;
  reconnectTimer = setTimeout(() => {
    reconnectTimer = null;
    reconnectDelay = Math.min(MAX_RECONNECT_DELAY, Math.floor(reconnectDelay * 1.8));
    connectWS();
  }, reconnectDelay);
}

function sendCmd(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    try {
      ws.send(JSON.stringify(obj));
    } catch (e) {
      console.warn("Failed to send cmd", e);
    }
  } else {
    console.warn("WebSocket not open; cannot send", obj);
  }
}

function handleMessage(obj) {
  if (!obj || !obj.type) return;

  if (obj.type === "profile") {
    profile = obj.profile || profile;
    drawProfile();
    hasProfile = true;
    // auto-adjust window if profile is long
    const maxProfileTime = (profile.time && profile.time.length) ? profile.time[profile.time.length-1] : 0;
    if (maxProfileTime > 120 && windowSeconds < 30) windowSeconds = Math.min(60, Math.round(maxProfileTime/6));
    document.getElementById('windowIn').value = windowSeconds;
  } else if (obj.type === "update") {
    const actual = (typeof obj.actual === 'number') ? obj.actual : parseFloat(obj.actual) || 0.0;
    const target = (typeof obj.target === 'number') ? obj.target : (parseFloat(obj.target) || 0.0);
    const timev = (typeof obj.time === 'number') ? obj.time : (parseFloat(obj.time) || 0.0);
    const violations = Number.isFinite(obj.violations) ? obj.violations : (parseInt(obj.violations) || 0);

    // update numeric displays safely
    document.getElementById("speed").innerText = actual.toFixed(1);
    document.getElementById("target").innerText = target.toFixed(1);
    document.getElementById("time").innerText = timev.toFixed(2);
    document.getElementById("viol").innerText = violations;

    addActualPoint(timev, actual);
  } else if (obj.type === "reset") {
    // Reset all displays
    document.getElementById("speed").innerText = "0.0";
    document.getElementById("target").innerText = "0.0";
    document.getElementById("time").innerText = "0.0";
    document.getElementById("viol").innerText = "0";
    
    // Reset slider
    const slider = document.getElementById('slider');
    const sliderVal = document.getElementById('sliderVal');
    slider.value = 0;
    sliderVal.innerText = "0.0";
    
    // Clear chart
    if (chart) {
      chart.data.datasets[3].data = [];
      chart.update();
    }
  } else if (obj.type === "complete") {
    alert("Test Completed! Violations: " + (obj.violations || 0));
  } else if (obj.type === "profile_loaded") {
    console.log("Profile loaded:", obj.filename);
    hasProfile = true;
  } else if (obj.type === "error") {
    alert("Error: " + (obj.message || "Unknown error"));
  }
}

// Draw initial profile graph
function drawProfile() {
  const times = profile.time || [];
  if (!times || times.length === 0) {
    // empty chart
    initChart();
    return;
  }

  const upper = (profile.upper||[]).map((v,i)=>({x:times[i]||0,y:(typeof v==='number'?v:parseFloat(v)||0)}));
  const lower = (profile.lower||[]).map((v,i)=>({x:times[i]||0,y:(typeof v==='number'?v:parseFloat(v)||0)}));
  const target = (profile.target||[]).map((v,i)=>({x:times[i]||0,y:(typeof v==='number'?v:parseFloat(v)||0)}));

  initChart(upper, lower, target);
}

function initChart(upperData, lowerData, targetData) {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        { label:'Upper', data: upperData || [], borderColor:'#ff2b2b', borderWidth:2, pointRadius:0, fill:false },
        { label:'Lower', data: lowerData || [], borderColor:'#007bff', borderWidth:2, pointRadius:0, fill:'-1' },
        { label:'Target', data: targetData || [], borderColor:'#0df27c', borderWidth:2.5, pointRadius:0 },
        { label:'Actual', data:[], borderColor:'#ffd400', borderWidth:3, pointRadius:6, pointHoverRadius:8, pointBackgroundColor:'#ffd400', pointBorderColor:'#ffffff', pointBorderWidth:2, showLine:true }
      ]
    },
    options: {
      animation:false,
      responsive:true,
      maintainAspectRatio:false,
      layout: {
        padding: {
          top: 10,
          bottom: 10,
          left: 5,
          right: 5
        }
      },
      elements: { point: { radius: 0 } },
      scales: {
        x: {
          type:'linear',
          min:0,
          max:windowSeconds,
          ticks:{ color:'#cfe8ff' },
          title:{ display:true, text:'Time (s)', color:'#cfe8ff' }
        },
        y: {
          min:-5,
          max:125,
          ticks:{ color:'#cfe8ff' },
          title:{ display:true, text:'Speed (km/h)', color:'#cfe8ff' }
        }
      },
      plugins:{ legend:{ labels:{ color:'#dfe9f3' } } }
    }
  });
}

// Add actual speed point to graph
function addActualPoint(t, speed) {
  if (!chart) return;
  if (!Number.isFinite(t) || !Number.isFinite(speed)) return;

  const ds = chart.data.datasets[3];
  ds.data.push({x:t, y:speed});

  // prune older points (keep only what falls inside last windowSeconds + margin)
  const minKeep = t - (windowSeconds + 5);
  chart.data.datasets.forEach(d => {
    d.data = d.data.filter(pt => pt.x >= minKeep);
  });

  // slide x-axis
  chart.options.scales.x.min = Math.max(0, t - windowSeconds);
  chart.options.scales.x.max = Math.max(windowSeconds, t);
  chart.update('none');
}

// UI wiring
document.getElementById("startBtn").onclick = ()=> sendCmd({cmd:'start'});
document.getElementById("stopBtn").onclick  = ()=> sendCmd({cmd:'stop'});
document.getElementById("resetBtn").onclick = ()=> {
  sendCmd({cmd:'reset'});
  // Reset all UI elements immediately
  document.getElementById("speed").innerText = "0.0";
  document.getElementById("target").innerText = "0.0";
  document.getElementById("time").innerText = "0.0";
  document.getElementById("viol").innerText = "0";
  
  // Reset slider to 0
  const slider = document.getElementById('slider');
  const sliderVal = document.getElementById('sliderVal');
  slider.value = 0;
  sliderVal.innerText = "0.0";
  
  // Clear chart data
  if(chart){ 
    chart.data.datasets[3].data=[]; 
    chart.update(); 
  }
};

document.getElementById("mode").onchange = (e)=> {
  sendCmd({cmd:"set_mode", mode:e.target.value});
};

// only send manual_speed when in manual mode
const slider = document.getElementById('slider');
const sliderVal = document.getElementById('sliderVal');
slider.oninput = (e)=>{
  const v = parseFloat(e.target.value);
  sliderVal.innerText = v.toFixed(1);
  const mode = document.getElementById('mode').value;
  if (mode === 'manual') sendCmd({cmd:'manual_speed', speed:v});
};

document.getElementById("windowIn").onchange = (e)=>{
  windowSeconds = Math.max(5, Math.min(300, parseFloat(e.target.value) || 30));
  if (chart) {
    // adjust visible window based on latest point
    const ds = chart.data.datasets[3].data;
    let latest = ds.length ? ds[ds.length-1].x : (profile.time && profile.time.length ? profile.time[profile.time.length-1] : 0);
    chart.options.scales.x.min = Math.max(0, latest - windowSeconds);
    chart.options.scales.x.max = Math.max(windowSeconds, latest);
    chart.update();
  }
};

// File upload handling
document.getElementById('csvFile').onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const fileName = file.name;
  document.getElementById('fileName').innerText = fileName;
  
  try {
    const text = await file.text();
    sendCmd({cmd: 'load_profile', csv_data: text, filename: fileName});
  } catch (error) {
    console.error('Error reading file:', error);
    alert('Error reading CSV file: ' + error.message);
  }
};

// start connection
connectWS();
</script>
</body>
</html>
